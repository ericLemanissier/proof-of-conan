name: Manual trigger

on:
  workflow_dispatch:
    inputs:
      repository:
        required: true
        default: 'conan-io/conan-center-index'
      ref:
        required: true
        default: 'master'
      path:
        required: true
        default: 'recipes/qt/6.x.x'
      version:
        required: true
        default: '6.5.1'

jobs:
  _:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-11]
        shared: ["True", "False"]
    continue-on-error: true
    env:
      NOT_ON_C3I: 1
    steps:    
      - name: Checkout
        uses: actions/checkout@v3
        with:
          repository: ${{ github.event.inputs.repository }}
          ref: ${{ github.event.inputs.ref }}
      - uses: actions/setup-python@v4
        with:
          python-version: "3.8"
      - run: pip3 install conan yq

      - run: conan profile detect --force
        shell: bash

      - run: |
          PROFILE_PATH=$(conan profile path default)
          COMPILER=$(awk -F "=" '/^compiler=/ {print $2}' $PROFILE_PATH)
          COMPILER_VERSION=$(awk -F "=" '/^compiler.version=/ {print $2}' $PROFILE_PATH)
          echo $PROFILE_PATH $COMPILER $COMPILER_VERSION
          CPP_STDS=$(curl https://github.com/conan-io/conan-center-index/raw/master/.c3i/config_v2.yml -L | yq -r -c .cppstd.\"$COMPILER\".\"$COMPILER_VERSION\"[])
          echo $CPP_STDS
          for cpp_std in $CPP_STDS; do
              echo $cpp_std
              cpp_std=$(echo $cpp_std | tr -d '\n' | tr -d ' ' | tr -d '\r' )
              echo $cpp_std
              conan create -s compiler.cppstd=$cpp_std --version ${{ github.event.inputs.version }} --build=missing ${{ github.event.inputs.path }} -o */*:shared=${{ matrix.shared }} -c tools.system.package_manager:mode=install -c tools.system.package_manager:sudo=True

              if [ $? -ne 6 ]; then
                  break
              fi
          done
          
        name: conan create
        shell: bash
        env:
          CONAN_SYSREQUIRES_MODE: enabled
